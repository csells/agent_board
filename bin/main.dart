// bin/service.dart
//
// A single-file, OpenAPI-compliant Dart service implementing the ACP session
// control-plane API. ACP integration is stubbed so you can wire acp_dart later.
//
// Run with:
//   dart run bin/service.dart
//

import 'dart:async';
import 'dart:convert';
import 'dart:io';

import 'package:shelf/shelf.dart';
import 'package:shelf_router/shelf_router.dart';
import 'package:shelf/shelf_io.dart' as io;
import 'package:shelf_web_socket/shelf_web_socket.dart';

void main() async {
  final service = AgentService();

    final router = Router()
        ..get('/openapi.yaml', service.openapiSpecHandler)
            ..get('/api/projects', service.listProjectsHandler)
                ..get('/api/agents', service.listAgentsHandler)
                    ..post('/api/sessions', service.createSessionHandler)
                        ..get('/api/sessions/<id>', service.getSessionHandler)
                            ..get('/api/sessions/<id>/events', service.getSessionEventsHandler)
                                ..get('/ws/sessions/<id>', service.sessionWebSocketHandler);

                                  final handler = const Pipeline()
                                        .addMiddleware(logRequests())
                                              .addMiddleware(_cors())
                                                    .addHandler(router);

                                                      final server = await io.serve(handler, InternetAddress.anyIPv4, 8080);
                                                        print('ðŸš€ Service running on http://${server.address.address}:${server.port}');
                                                        }

                                                        //
                                                        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                                                        // DATA MODELS
                                                        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                                                        //

                                                        class Project {
                                                          final String id;
                                                            final String name;
                                                              final String path;
                                                                Project(this.id, this.name, this.path);

                                                                  Map<String, dynamic> toJson() =>
                                                                        {'id': id, 'name': name, 'path': path};
                                                                        }

                                                                        class Agent {
                                                                          final String id;
                                                                            final String name;
                                                                              const Agent(this.id, this.name);

                                                                                Map<String, dynamic> toJson() =>
                                                                                      {'id': id, 'name': name};
                                                                                      }

                                                                                      enum SessionState { running, done, failed, cancelled }

                                                                                      class Session {
                                                                                        final String id;
                                                                                          final String agentId;
                                                                                            final String projectId;
                                                                                              final String prompt;
                                                                                                SessionState state;
                                                                                                  DateTime createdAt;
                                                                                                    DateTime updatedAt;
                                                                                                      final List<SessionEvent> events = [];

                                                                                                        Session({
                                                                                                            required this.id,
                                                                                                                required this.agentId,
                                                                                                                    required this.projectId,
                                                                                                                        required this.prompt,
                                                                                                                          })  : state = SessionState.running,
                                                                                                                                  createdAt = DateTime.now(),
                                                                                                                                          updatedAt = DateTime.now();

                                                                                                                                            Map<String, dynamic> toJson() => {
                                                                                                                                                    'id': id,
                                                                                                                                                            'agentId': agentId,
                                                                                                                                                                    'projectId': projectId,
                                                                                                                                                                            'prompt': prompt,
                                                                                                                                                                                    'state': state.name,
                                                                                                                                                                                            'createdAt': createdAt.toIso8601String(),
                                                                                                                                                                                                    'updatedAt': updatedAt.toIso8601String(),
                                                                                                                                                                                                          };
                                                                                                                                                                                                          }

                                                                                                                                                                                                          class SessionEvent {
                                                                                                                                                                                                            final String id;
                                                                                                                                                                                                              final String sessionId;
                                                                                                                                                                                                                final String type;
                                                                                                                                                                                                                  final Map<String, dynamic> payload;
                                                                                                                                                                                                                    final DateTime timestamp;

                                                                                                                                                                                                                      SessionEvent({
                                                                                                                                                                                                                          required this.id,
                                                                                                                                                                                                                              required this.sessionId,
                                                                                                                                                                                                                                  required this.type,
                                                                                                                                                                                                                                      required this.payload,
                                                                                                                                                                                                                                        }) : timestamp = DateTime.now();

                                                                                                                                                                                                                                          Map<String, dynamic> toJson() => {
                                                                                                                                                                                                                                                  'id': id,
                                                                                                                                                                                                                                                          'sessionId': sessionId,
                                                                                                                                                                                                                                                                  'type': type,
                                                                                                                                                                                                                                                                          'payload': payload,
                                                                                                                                                                                                                                                                                  'timestamp': timestamp.toIso8601String(),
                                                                                                                                                                                                                                                                                        };
                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                        //
                                                                                                                                                                                                                                                                                        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                                                                                                                                                                                                                                                                                        // SERVICE IMPLEMENTATION
                                                                                                                                                                                                                                                                                        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                                                                                                                                                                                                                                                                                        //

                                                                                                                                                                                                                                                                                        class AgentService {
                                                                                                                                                                                                                                                                                          final _projects = <String, Project>{
                                                                                                                                                                                                                                                                                              'flutter_ai_toolkit': Project(
                                                                                                                                                                                                                                                                                                    'flutter_ai_toolkit',
                                                                                                                                                                                                                                                                                                          'Flutter AI Toolkit',
                                                                                                                                                                                                                                                                                                                '/Users/chris/code/flutter_ai_toolkit',
                                                                                                                                                                                                                                                                                                                    ),
                                                                                                                                                                                                                                                                                                                        'muse': Project(
                                                                                                                                                                                                                                                                                                                              'muse',
                                                                                                                                                                                                                                                                                                                                    'Muse Chat',
                                                                                                                                                                                                                                                                                                                                          '/Users/chris/code/muse',
                                                                                                                                                                                                                                                                                                                                              ),
                                                                                                                                                                                                                                                                                                                                                };

                                                                                                                                                                                                                                                                                                                                                  final _agents = const <String, Agent>{
                                                                                                                                                                                                                                                                                                                                                      'claude': Agent('claude', 'Claude Code'),
                                                                                                                                                                                                                                                                                                                                                          'gemini': Agent('gemini', 'Gemini CLI'),
                                                                                                                                                                                                                                                                                                                                                              'codex': Agent('codex', 'Codex'),
                                                                                                                                                                                                                                                                                                                                                                };

                                                                                                                                                                                                                                                                                                                                                                  final _sessions = <String, Session>{};
                                                                                                                                                                                                                                                                                                                                                                    final _eventStreams = <String, StreamController<SessionEvent>>{};

                                                                                                                                                                                                                                                                                                                                                                      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                                                                                                                                                                                                                                                                                                                                                                        // REST HANDLERS
                                                                                                                                                                                                                                                                                                                                                                          // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

                                                                                                                                                                                                                                                                                                                                                                            Response openapiSpecHandler(Request req) {
                                                                                                                                                                                                                                                                                                                                                                                return Response.ok(_openapiYaml, headers: {'content-type': 'text/yaml'});
                                                                                                                                                                                                                                                                                                                                                                                  }

                                                                                                                                                                                                                                                                                                                                                                                    Response listProjectsHandler(Request req) {
                                                                                                                                                                                                                                                                                                                                                                                        return Response.ok(
                                                                                                                                                                                                                                                                                                                                                                                              jsonEncode(_projects.values.map((p) => p.toJson()).toList()),
                                                                                                                                                                                                                                                                                                                                                                                                    headers: {'content-type': 'application/json'},
                                                                                                                                                                                                                                                                                                                                                                                                        );
                                                                                                                                                                                                                                                                                                                                                                                                          }

                                                                                                                                                                                                                                                                                                                                                                                                            Response listAgentsHandler(Request req) {
                                                                                                                                                                                                                                                                                                                                                                                                                return Response.ok(
                                                                                                                                                                                                                                                                                                                                                                                                                      jsonEncode(_agents.values.map((a) => a.toJson()).toList()),
                                                                                                                                                                                                                                                                                                                                                                                                                            headers: {'content-type': 'application/json'},
                                                                                                                                                                                                                                                                                                                                                                                                                                );
                                                                                                                                                                                                                                                                                                                                                                                                                                  }

                                                                                                                                                                                                                                                                                                                                                                                                                                    Future<Response> createSessionHandler(Request req) async {
                                                                                                                                                                                                                                                                                                                                                                                                                                        final body = jsonDecode(await req.readAsString());
                                                                                                                                                                                                                                                                                                                                                                                                                                            final agentId = body['agentId'] as String;
                                                                                                                                                                                                                                                                                                                                                                                                                                                final projectId = body['projectId'] as String;
                                                                                                                                                                                                                                                                                                                                                                                                                                                    final prompt = body['prompt'] as String;

                                                                                                                                                                                                                                                                                                                                                                                                                                                        if (!_agents.containsKey(agentId)) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                              return Response(400,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        body: jsonEncode({'error': 'Unknown agent $agentId'}),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  headers: {'content-type': 'application/json'});
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          if (!_projects.containsKey(projectId)) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return Response(400,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          body: jsonEncode({'error': 'Unknown project $projectId'}),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    headers: {'content-type': 'application/json'});
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            final sessionId = _randomId();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                final session = Session(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      id: sessionId,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            agentId: agentId,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  projectId: projectId,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        prompt: prompt,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                _sessions[sessionId] = session;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    final controller = StreamController<SessionEvent>.broadcast();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        _eventStreams[sessionId] = controller;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            // Kick off stubbed ACP session in background
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                _runStubAcpSession(session, controller);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return Response.ok(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          jsonEncode({'id': sessionId, 'state': session.state.name}),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                headers: {'content-type': 'application/json'},
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        Response getSessionHandler(Request req, String id) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            final s = _sessions[id];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if (s == null) return Response.notFound(jsonEncode({'error': 'not found'}));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return Response.ok(jsonEncode(s.toJson()),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            headers: {'content-type': 'application/json'});
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                Response getSessionEventsHandler(Request req, String id) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    final s = _sessions[id];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if (s == null) return Response.notFound(jsonEncode({'error': 'not found'}));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return Response.ok(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  jsonEncode(s.events.map((e) => e.toJson()).toList()),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        headers: {'content-type': 'application/json'},
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  // WEBSOCKET HANDLER
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      Response sessionWebSocketHandler(Request req, String id) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          final s = _sessions[id];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              if (s == null) return Response.notFound('session not found');

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  return webSocketHandler((socket) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // Send existing events
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              for (final e in s.events) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      socket.add(jsonEncode(e.toJson()));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  // Stream new events
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        final sub = _eventStreams[id]!.stream.listen((e) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                socket.add(jsonEncode(e.toJson()));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            socket.done.then((_) => sub.cancel());
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                })(req);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      // ACP STUB (replace with real acp_dart calls later)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          Future<void> _runStubAcpSession(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                Session session, StreamController<SessionEvent> stream) async {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // Simulate events
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        Future<void> add(String type, Map<String, dynamic> payload) async {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              final e = SessionEvent(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      id: _randomId(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              sessionId: session.id,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      type: type,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              payload: payload,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          session.events.add(e);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                stream.add(e);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      session.updatedAt = DateTime.now();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              await add('plan', {'message': 'Planning edits...'});
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  await Future.delayed(Duration(seconds: 1));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      await add('log', {'line': 'Analyzing project files...'});
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          await Future.delayed(Duration(seconds: 1));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              await add('diff', {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'file': 'lib/main.dart',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          'diff': '@@ -1,5 +1,5 @@\n- old\n+ new'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  await Future.delayed(Duration(seconds: 1));

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      session.state = SessionState.done;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          session.updatedAt = DateTime.now();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              await stream.close();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // UTIL
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        String _randomId() => DateTime.now().microsecondsSinceEpoch.toRadixString(16);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        //
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // OPENAPI SPEC (inline YAML)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        //

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const _openapiYaml = '''
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        openapi: 3.1.0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        info:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          title: Agent Control Plane API
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            version: 1.0.0

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            paths:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              /api/projects:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  get:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        summary: List all projects
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              responses:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      '200':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                description: OK
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  /api/agents:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      get:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            summary: List all agents
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  responses:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          '200':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    description: OK
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      /api/sessions:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          post:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                summary: Start a new agent session
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      requestBody:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              required: true
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    responses:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            '200':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      description: Session created
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        /api/sessions/{id}:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            get:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  summary: Get session metadata
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        parameters:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              - name: id
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      in: path
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              required: true
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    responses:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            '200':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      description: OK
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        /api/sessions/{id}/events:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            get:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  summary: List historical events for a session
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        parameters:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              - name: id
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      in: path
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              required: true
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    responses:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            '200':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      description: OK
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        /ws/sessions/{id}:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            get:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  summary: WebSocket stream of session events
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        parameters:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              - name: id
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      in: path
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              required: true
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    responses:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            '101':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      description: Switching protocols
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ''';

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      //
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      // CORS MIDDLEWARE
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      //

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      Middleware _cors() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return (inner) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return (req) async {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  final res = await inner(req);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return res.change(headers: {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ...res.headers,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'Access-Control-Allow-Origin': '*',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'Access-Control-Allow-Headers': 'Content-Type',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }